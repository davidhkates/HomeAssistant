# sensor templates for for formatting various time and weather entities

# Sunset as local time in hh:mm am/pm
- name: "Sunset"
  unique_id: sun.sunset
  state: >
    {{ state_attr('sun.sun', 'next_setting')
       | as_datetime
       | as_local
       | as_timestamp
       | timestamp_custom('%I:%M %p')         
    }}
    
# Tesla Model 3 charging status
- name: "Model 3 Charging (Display)"
  unique_id: tesla_model_3_charging_display
  state: >
    {% set s = states('sensor.model_3_charging') %}
    {{ s if s not in ['unknown', 'unavailable', 'None', ''] else 'hide_me' }}

# Tesla Model 3 projected charge completion time in local hh:mm am/pm
- name: "Model 3 Charging Complete"
  unique_id: tesla_model_3_charging_complete
  state: >
    {{ states('sensor.model_3_time_to_full_charge')
       | as_datetime
       | as_local
       | as_timestamp
       | timestamp_custom('%I:%M %p')         
    }}

# Weather forecast of today's low
- name: "Weather Forecast Today's Low"
  unique_id: weather_forecast_todays_low
  unit_of_measurement: "°F"
  #state: "{{ daily_forecast['weather.home'].forecast[0].templow }}"
  #value_template: >
  state: >
    {% set forecast = state_attr('weather.openweathermap', 'forecast') %}
    {% if forecast %}
      {% set today = now().date() %}
      {% for f in forecast %}
        {% if f.datetime.date() == today %}
          {{ f.templow }}
        {% endif %}
      {% endfor %}
    {% else %}
      unavailable
    {% endif %}
        
# Weather forecast of tomorrow's low
- name: "Weather Forecast Tomorrow's Low"
  unique_id: weather_forecast_tomorrows_low
  unit_of_measurement: "°F"
  state: >
    {% set forecast = state_attr('weather.openweathermap', 'forecast') %}
    {% if forecast %}
      {% set tomorrow = (now() + timedelta(days=1)).date() %}
      {% for f in forecast %}
        {% if f.datetime.date() == tomorrow %}
          {{ f.templow }}
        {% endif %}
      {% endfor %}
    {% else %}
      unavailable
    {% endif %}
